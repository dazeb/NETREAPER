#!/usr/bin/env bash
# ═══════════════════════════════════════════════════════════════════════════════
# NETREAPER - Network Security & WiFi Assault Toolkit
# ═══════════════════════════════════════════════════════════════════════════════
# Copyright (c) 2025 Nerds489
# SPDX-License-Identifier: Apache-2.0
#
# Thin dispatcher: sources libraries and modules, then routes to handlers.
# ═══════════════════════════════════════════════════════════════════════════════

set -euo pipefail

# ═══════════════════════════════════════════════════════════════════════════════
# SOURCE LIBRARIES
# ═══════════════════════════════════════════════════════════════════════════════

# Resolve NETREAPER_ROOT (parent of bin/)
NETREAPER_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
export NETREAPER_ROOT

# Source version helper first (provides NETREAPER_ROOT and VERSION)
# shellcheck source=../lib/version.sh
source "$NETREAPER_ROOT/lib/version.sh"

# Source core libraries in dependency order
# Each lib has a guard to prevent multiple sourcing
for lib in core ui safety detection utils; do
    # shellcheck source=/dev/null
    source "$NETREAPER_ROOT/lib/${lib}.sh" || {
        echo "ERROR: Failed to source lib/${lib}.sh" >&2
        exit 1
    }
done

# ═══════════════════════════════════════════════════════════════════════════════
# SOURCE MODULES
# ═══════════════════════════════════════════════════════════════════════════════

# Source all modules (each has its own guard)
for mod in "$NETREAPER_ROOT/modules"/*.sh; do
    [[ -f "$mod" ]] && source "$mod"
done

# ═══════════════════════════════════════════════════════════════════════════════
# INITIALIZATION
# ═══════════════════════════════════════════════════════════════════════════════

# Create required directories (from core.sh)
ensure_directories

# Detect system info (from detection.sh)
detect_system

# ═══════════════════════════════════════════════════════════════════════════════
# CLI FUNCTIONS
# ═══════════════════════════════════════════════════════════════════════════════

_show_version() {
    echo "netreaper v${VERSION} (Phantom Protocol)"
}

_show_help() {
    cat << 'EOF'
NETREAPER - Network Security & WiFi Assault Toolkit

Usage: netreaper [command] [options]

Options:
  -h, --help      Show this help message
  -V, --version   Show version information
  --dry-run       Preview commands without executing

Commands:
  status          Show tool installation status
  scan <target>   Run a quick port scan
  wifi            WiFi operations
  config path     Show config directory path
  help            Show this help message

Examples:
  netreaper --version
  netreaper status
  netreaper scan 192.168.1.1
  netreaper --dry-run scan 192.168.1.1
  netreaper config path

Run without arguments to launch the interactive menu.
EOF
}

_show_status() {
    # Delegate to module function if available
    if declare -f show_tool_status &>/dev/null; then
        show_tool_status
        return
    fi

    # Fallback: basic status display
    log_info "System: ${DISTRO:-unknown} (${DISTRO_FAMILY:-unknown})"
    log_info "Package manager: ${PKG_MANAGER:-unknown}"
    log_info "NETREAPER root: ${NETREAPER_ROOT}"
    echo
    log_info "Core tools:"
    for tool in nmap aircrack-ng hashcat wireshark; do
        if command -v "$tool" &>/dev/null; then
            echo -e "    ${C_GREEN}[✓]${C_RESET} $tool"
        else
            echo -e "    ${C_RED}[✗]${C_RESET} $tool"
        fi
    done
}

# ═══════════════════════════════════════════════════════════════════════════════
# MAIN
# ═══════════════════════════════════════════════════════════════════════════════

main() {
    case "${1:-}" in
        -V|--version)
            _show_version
            exit 0
            ;;
        -h|--help)
            _show_help
            exit 0
            ;;
        --dry-run)
            NR_DRY_RUN=1
            export NR_DRY_RUN
            log_info "Dry-run mode enabled"
            shift
            if [[ -n "${1:-}" ]]; then
                main "$@"
            fi
            exit 0
            ;;
        help)
            _show_help
            exit 0
            ;;
        config)
            case "${2:-}" in
                path)
                    echo "$CONFIG_DIR"
                    ;;
                *)
                    log_error "Unknown config subcommand: ${2:-}"
                    echo "Usage: netreaper config path"
                    ;;
            esac
            exit 0
            ;;
        status)
            _show_status
            exit 0
            ;;
        scan)
            shift
            if declare -f run_nmap_quick &>/dev/null && [[ -n "${1:-}" ]]; then
                run_nmap_quick "$1"
            else
                log_info "Scan command placeholder - modules not yet migrated"
            fi
            exit 0
            ;;
        wifi)
            if declare -f menu_wireless &>/dev/null; then
                menu_wireless
            else
                log_info "WiFi command placeholder - modules not yet migrated"
            fi
            exit 0
            ;;
        "")
            # No arguments: launch interactive menu
            if declare -f main_menu &>/dev/null; then
                main_menu
            else
                log_info "Interactive menu not yet available"
                log_info "Run 'netreaper --help' for available commands"
            fi
            exit 0
            ;;
        *)
            log_error "Unknown command: $1"
            echo "Run 'netreaper --help' for usage"
            exit 1
            ;;
    esac
}

# Entry point (allows sourcing for tests without executing)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
